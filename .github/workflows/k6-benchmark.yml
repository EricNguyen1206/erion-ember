name: K6 Benchmark (Legacy HTTP)

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress
          - soak
      http_benchmarks:
        description: 'Run legacy HTTP benchmarks (disabled for MCP by default)'
        required: true
        default: 'disabled'
        type: choice
        options:
          - disabled
          - enabled

jobs:
  benchmark:
    if: ${{ inputs.http_benchmarks == 'enabled' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup K6
      uses: grafana/setup-k6-action@v1
      with:
        version: latest
    
    - name: Start services
      run: |
        docker compose up -d erion-ember redis
        echo "Waiting for services to be ready..."
        sleep 15
    
    - name: Verify services are running
      run: |
        curl -f http://localhost:3000/health || exit 1
        docker compose ps
    
    - name: Select test script
      id: select-test
      run: |
        case "${{ inputs.test_type }}" in
          smoke) echo "script=benchmark/k6/smoke-test.js" >> $GITHUB_OUTPUT ;;
          load) echo "script=benchmark/k6/load-test.js" >> $GITHUB_OUTPUT ;;
          stress) echo "script=benchmark/k6/stress-test.js" >> $GITHUB_OUTPUT ;;
          soak) echo "script=benchmark/k6/soak-test.js" >> $GITHUB_OUTPUT ;;
        esac

    - name: Run benchmark
      run: |
        k6 run \
          --out json=benchmark/results/${{ inputs.test_type }}-test.json \
          --env CORE_URL=http://localhost:3000 \
          ${{ steps.select-test.outputs.script }}
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: k6-results-${{ github.sha }}
        path: benchmark/results/*.json
        retention-days: 30
    
    - name: Generate benchmark summary
      if: always()
      run: |
        if [ -f benchmark/results/${{ inputs.test_type }}-test.json ]; then
          echo "✅ Benchmark completed successfully"
          echo "Results:"
          cat benchmark/results/${{ inputs.test_type }}-test.json | head -100
        else
          echo "❌ Benchmark results not found"
        fi
    
    - name: Cleanup
      if: always()
      run: docker compose down
